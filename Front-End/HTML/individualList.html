<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
  	<meta charset="utf-8">
  	<meta name="viewport" content="width=device-width, initial-scale=1">
  	<title>ShappList</title>
  	{% load static %}
	<link rel="stylesheet" href="{% static 'ShappList/bootstrap/css/bootstrap.min.css' %}">
	<link rel="stylesheet" href="{% static 'ShappList/css/sindList.css' %}">
	<link rel="stylesheet" href="{% static 'ShappList/css/fixed.css' %}">
    <script type="text/javascript" src="{% static 'ShappList/js/checkNumber.js' %}"></script>
    <script type="text/javascript" src="{% static 'ShappList/js/list_price.js' %}"></script>

    <!-- Font Awesome JS -->
    <script defer src="https://use.fontawesome.com/releases/v5.0.13/js/solid.js" integrity="sha384-tzzSw1/Vo+0N5UhStP3bvwWPq+uvzCMfrN1fEFe+xBmv1C/AtVX5K0uZtmcHitFZ" crossorigin="anonymous"></script>
    <script defer src="https://use.fontawesome.com/releases/v5.0.13/js/fontawesome.js" integrity="sha384-6OIrr52G08NpOFSZdxxz1xdNSndlD4vdcf/q2myIUVO0VsqaGHJsB0RaBE01VTOY" crossorigin="anonymous"></script>
  </head>

  <body data-spy="scroll" onload="pageSetup()">

      <!-- Page Content  -->
      <div id="content">

          <nav id="nav-mobile" class="navbar fixed-bottom">
            <div class="row rowIcons">
              <div class="col-4 text-center">
                <a href="lists"><i class="icon fas fa-list-alt fa-3x" ></i></a>
              </div>
              <div class="col-4 text-center">
                  <a href="products"><i class="icon fas fa-shopping-bag fa-3x" ></i></a>
              </div>
              <div class="col-4 text-center">
                  <a href="settings"><i class="icon fas fa-user-circle fa-3x" ></i></a>
              </div>
            </div> <!--- End Row -->
        </nav><!--- End Navigation --->

        <nav id="nav-desktop" class="navbar fixed-top">
            <div class="row rowIcons">
              <div class="col-4 text-center">
                <a href="lists"><i class="icon fas fa-list-alt" ></i></a>
              </div>
              <div class="col-4 text-center">
                  <a href="products"><i class="icon fas fa-shopping-bag" ></i></a>
              </div>
              <div class="col-4 text-center">
                  <a href="settings"><i class="icon fas fa-user-circle" ></i></a>
              </div>
            </div> <!--- End Row -->
        </nav><!--- End Navigation --->

          <!-- MY LISTS HEADER -->
          <div class="" id="filters">
              <a href="lists" >
                <button class="btn backButton" type="button">
                    <i class="fas fa-chevron-left backIcon"></i>
              	</button>
              </a>
          </div>

          <div class="row myLists" style="background: #ff983f!important;">
            <div class="col-9 listNameContainer">
              <span id="listNameContainer"></span>
            </div>
          </div>

          <a  href="#"><img class="logo" src="{% static 'ShappList/resources/logo-white.png' %}"></a>

         <!-- EDIT IND LIST -->
          <div class="" id="addLists">
                <button class="btn float" type="button" onclick="openOverlay()">
                  <i class="fas fa-ellipsis-v"></i>
              	</button>
          </div>

          <div class="" id="participants">
                <button class="btn floatP" type="button" onclick="openParts()">
                  <i class="fas fa-user-friends filterIcon"></i>
              	</button>
          </div>


         <!-- Anti-Overlay IP + Add Participant -->
          <div class="anti-overlay" id="closeOverlay" onclick="closeOverlay()"></div>

         <!-- Overlay Settings-->
          <div class="overlay" id="overlay" >
              <div class="overlay-content ">
                  <div class="row ">
                    <div class="col-12 ">
                      <p class="overlayTitle"> DEFINIÇÕES </p> <a href="javascript:void(0)" class="closebtnAP overlayRef" onclick="closeOverlay()">×</a>
                    </div>
                  </div>
                  <div id="makeListActive" class="row lists text-left makeListActive">
                    <div class="col-12 lists text-center">
                      <button type="button" onclick="setActiveList()"  class="viewMode btn">Tornar esta Lista Ativa</button>
                    </div>
                  </div>
                  <div class="row lists text-left">
                    <div class="col-12 lists text-center">
                      <button type="button" onclick="changeMode()"  class="viewMode btn">Mudar Modo de Visualização</button>
                    </div>
                  </div>
                  <div class="row lists text-left">
                    <div class="col-10 lists">
                      <p class="overlaySuper">Pingo Doce</p>
                    </div>
                    <div class="col-2 lists">
                      <label class="containerC">
                        <input id="pingoCheck" onchange ="setAcceptedStores(1)" type="checkbox" checked>
                        <span class="checkmark"></span>
                      </label>
                    </div>
                  </div>
                  <div class="row lists text-left">
                    <div class="col-10 lists">
                      <p class="overlaySuper">Continente</p>
                    </div>
                    <div class="col-2 lists">
                      <label class="containerC">
                        <input id="contCheck" onchange ="setAcceptedStores(2)" type="checkbox" checked>
                        <span class="checkmark"></span>
                      </label>
                    </div>
                  </div>
                  <div class="row lists text-left">
                    <div class="col-10 lists">
                      <p class="overlaySuper">Jumbo</p>
                    </div>
                    <div class="col-2 lists">
                      <label class="containerC">
                        <input id="jumboCheck" onchange ="setAcceptedStores(3)" type="checkbox" checked>
                        <span class="checkmark"></span>
                      </label>
                    </div>
                  </div>

                  <div class="row ">
                    <div class="col-12 text-center">
                      <button type="button" onclick="saveChanges()"  class="addProdToList btn">Guardar Alterações</button>
                    </div>
                  </div>
                  <div class="row ">
                    <div class="col-12 text-center">
                      <button type="button" id="buttonCancelList" onclick="delList()"  class="delList btn">Apagar Lista</button>
                    </div>
                  </div>
              </div>
            </div>

        <!-- OVERLAY PARTICIPANTES -->

          <div class="overlayPart" id="overlayPart" >
                <div class="overlay-content ">

                    <div class="row ">
                      <div class="col-12 headerPart">
                        <p class="overlayTitle"> PARTICIPANTES </p> <a href="javascript:void(0)" class="closebtnAP overlayRef" onclick="closeOverlay()">×</a>
                      </div>
                    </div>
                    <div class="row ">
                      <div class="col-12 text-center">
                        <button type="button" onclick="overlayOaC()" class="openPart btn">Adicionar Participante</button>
                      </div>
                    </div>
                    <div class="row lists text-left">
                      <div class="col-9 lists text-left">
                        <p class="overlaySubTitle" >ATIVOS</p>
                      </div>
                    </div>

                    <div id="acceptedContainer" class="row lists ">
                      <div class="col-9 lists text-left">
                        <p id="grandaTracinhoActive" class="overlaySuper" ><span id="partActiveName"></span> - <span id="partActiveNumber"></span></p>
                      </div>
                      <div class="col-3 lists text-right">

                      </div>
                    </div>


                    <div class="row lists text-left">
                      <div class="col-9 lists text-left">
                        <p class="overlaySubTitle pend" >PENDENTES</p>
                      </div>
                    </div>

                    <div id= "pendingContainer" class="row lists ">
                      <div class="col-12 lists text-left">
                        <p id="grandaTracinhoPendente" class="overlaySuper" ><span id="partPendingName"></span> - <span id="partPendingNumber"></span></p>
                      </div>
                    </div>



                </div>
              </div>


          <div class="overlayAddPart" id="overlayAddPart" onclick="">
                  <div class="row text-center">
                    <div class="participantsHeader col-12">
                      <p>Adicionar Participante</p> <a href="javascript:void(0)" class="closebtn" onclick="closeOverlay()">×</a>
                    </div>
                  </div>

                  <div class="row listAddPart text-left">
                    <div class="col-12">
                      <div class="form-group d-flex justify-content-center">
                        <input type="text" id="number" class="form-control" placeholder="Número de Telemóvel">
                      </div>
                    </div>

                  </div>
                <div class="row justify-content-center">
                  <button type="submit" class="addPart btn" onclick="getUserForInvite()">Adicionar</button>
                </div>
                <div class="row justify-content-center errorDiv">
                    <div id="errorMsg" class="errorMsg text-center" >
      						<p></p>
      			    </div>
                </div>
          </div>

        <!-- Overlay Delete Product-->
        <div class="overlayDelProd" id="overlayDelProd" >
            <div class="row ">
              <div class="col-12 text-center">
                <button type="button"  class="remProd btn">Eliminar Produto</button>
              </div>
            </div>
        </div>



          <!-- MY LISTS -->
          <div class="container" >
            <div id="productsContainer" class="products text-left">
                <div id="noProds" class="noProds text-left">
                    <p>Não tem produtos adicionados a esta lista. Adicione produtos <a href="products">aqui</a>!</p>
                </div>

            </div>

            <div class="buttonCalc text-center">
                <button type="submit" class="btnCalc btn" onclick="buttonCalc()">Calcular Valor Total</button>
            </div>

              <div class="products ">

              <div class="row results text-center">
                <div class="col-4 colSuper">
                  <p class="superName">Pingo Doce</p>
                </div>
                <div class="col-4 colSuper">
                  <p class="superName">Continente</p>
                </div>
                <div class="col-4 colSuper">
                  <p class="superName">Jumbo</p>
                </div>
              </div>
              <div class="row resultsValues text-center">
                <div class="col-4 superValue">
                  <p class="pSuperValue" id="pricePG"></p>
                </div>
                <div class="col-4 superValue">
                  <p class="pSuperValue" id="priceC"></p>
                </div>
                <div class="col-4 superValue">
                  <p class="pSuperValue" id="priceJ"></p>
                </div>
              </div>

              <div id="bestSuper" class="bestSuper text-left">
                <p><span id="supermercado"></span><span id="bestValue"></span></p>
              </div>
              <div class="bestSuper text-left" id="missingContent">

              </div>

            </div>

          </div>


    </div>



    <script type="text/javascript" languague="javascript">

      var localListID = sessionStorage.newPageList;
      var width = window.screen.availWidth;
      var mode = 0;
      var globalResponseData;
      var globalProds = [];
      var acceptedStores = [1,2,3];

      function pageSetup(){

            if(localListID != localStorage.activeList){
                document.getElementById("makeListActive").style.display = "inline";
            }

            if(!localStorage.acceptedStores){
               localStorage.setItem("acceptedStores",[1,2,3]);
            }
            else{
                changeUserPrefs(localStorage.acceptedStores);
            }


            sendAjaxCheckIfOwner();
            sendAjaxGetList();

      }


      function hold(listID,itemID){
          if (width <= 1200){
            var touchStartTimeStamp = 0;
            var touchEndTimeStamp   = 0;
            var timer = 0;


            document.getElementById("itemTextID" +itemID.toString()).addEventListener('touchstart', onTouchStart,false);
            document.getElementById("itemTextID" +itemID.toString()).addEventListener('touchend', onTouchEnd,false);

            function onTouchStart(e) {
                e.preventDefault();
                touchStartTimeStamp = e.timeStamp;
            }

            function onTouchEnd(e) {
                e.preventDefault();
                touchEndTimeStamp = e.timeStamp;
                touchLength = touchEndTimeStamp - touchStartTimeStamp;


                if(touchLength>500){
                    //quando hold

                    document.getElementById("overlayDelProd").style.display = "block";
                    document.getElementById("closeOverlay").style.display = "block";
                    document.getElementById('overlayDelProd').onclick = function() { delItem(listID,itemID) };

                }
            }
          }
      }

      function getUserForInvite(){
            phoneVal = document.getElementById("number").value;
            if(checkNumber(phoneVal)){
                sendAjaxGetParticipant(phoneVal);
            }
            else{
                document.getElementById("errorMsg").style.color =  "#ff0000";
                document.getElementById("errorMsg").innerHTML = "Por favor introduza um número válido!"
            }
        }

      function sendAjaxGetParticipant(phoneNum){
            console.log('Creating ajax object');
                var ajaxRequest = new XMLHttpRequest();
                ajaxRequest.onreadystatechange = function() {
                    if (ajaxRequest.readyState == 4) {   // XMLHttpRequest.DONE == 4
                        if (ajaxRequest.status == 200) {

                            var responseData = JSON.parse(ajaxRequest.responseText);

                            if(responseData.status == 200){
                                document.getElementById("errorMsg").style.color =  "#00ff00";
                                document.getElementById("errorMsg").innerHTML = "Convite enviado com sucesso!";
                            }
                            else if(responseData.status == 300){
                                document.getElementById("errorMsg").style.color =  "#ff0000";
                                document.getElementById("errorMsg").innerHTML = "Número de telefone não está associado a nenhum utilizador!";
                            }

                            else if(responseData.status == 500){
                                document.getElementById("errorMsg").style.color =  "#ff0000";
                                document.getElementById("errorMsg").innerHTML = "Não pode enviar convites a si próprio!";
                            }
                            else if(responseData.status == 600){
                                document.getElementById("errorMsg").style.color =  "#ff0000";
                                document.getElementById("errorMsg").innerHTML = "Utilizador já se encontra adicionado à lista!";

                            }

                        }
                        else if (ajaxRequest.status == 400) {
                            console.log('There was an error 400');
                        }
                        else {
                            console.log('something else other than 200 was returned');
                        }
                    }
                };
                console.log('Sending ajax');
                ajaxRequest.open("POST", "https://shapplist.pythonanywhere.com/api/listServices/api_getParticipant", true);
                ajaxRequest.setRequestHeader("content-type", "application/json; charset=utf-8");

                var listid = sessionStorage.newPageList;
                data = JSON.stringify({'phoneNum' : phoneNum,'listID' :listid});

                ajaxRequest.send(data);
        }

      function sendAjaxCheckIfOwner(){
           console.log('Creating ajax object');
                var ajaxRequest = new XMLHttpRequest();
                ajaxRequest.onreadystatechange = function() {
                    if (ajaxRequest.readyState == 4) {   // XMLHttpRequest.DONE == 4
                        if (ajaxRequest.status == 200) {

                            var responseData = JSON.parse(ajaxRequest.responseText);
                            var flag = responseData['owner'];
                            if(flag){
                               isOwner(true)
                            }
                            else{
                                isOwner(false)
                            }

                        }
                        else if (ajaxRequest.status == 400) {
                            console.log('There was an error 400');
                        }
                        else {
                            console.log('something else other than 200 was returned');
                        }
                    }
                };
                console.log('Sending ajax');
                ajaxRequest.open("POST", "https://shapplist.pythonanywhere.com/api/listServices/api_checkIfOwnerOfList", true);
                ajaxRequest.setRequestHeader("content-type", "application/json; charset=utf-8");
                var listid = sessionStorage.newPageList;
                data = JSON.stringify({'listID' :listid});

                ajaxRequest.send(data);
      }

      function sendAjaxGetList(){
            console.log('Creating ajax object');
                var ajaxRequest = new XMLHttpRequest();
                ajaxRequest.onreadystatechange = function() {
                    if (ajaxRequest.readyState == 4) {   // XMLHttpRequest.DONE == 4
                        if (ajaxRequest.status == 200) {

                            var responseData = JSON.parse(ajaxRequest.responseText);
                            globalResponseData = responseData;
                            writeLists(responseData)
                        }
                        else if (ajaxRequest.status == 400) {
                            alert('There was an error 400');
                        }
                        else {
                            alert('something else other than 200 was returned');
                        }
                    }
                };
                console.log('Sending ajax');
                ajaxRequest.open("POST", "https://shapplist.pythonanywhere.com/api/listServices/api_getListProductsByCategory", true);
                ajaxRequest.setRequestHeader("content-type", "application/json; charset=utf-8");

                var listid = sessionStorage.newPageList;
                data = JSON.stringify({'listID' : listid});

                ajaxRequest.send(data);
        }

     function isOwner(bool){

         if(bool){
             //é owner -> pode eliminar lista -> botao diz "Eliminar lista" e faz funcionalidade que já temos
             document.getElementById("buttonCancelList").innerHTML = "Apagar Lista";
             document.getElementById("buttonCancelList").onclick = function() {delList()};
         }
         else{
             // nao é owner -> não pode eliminar lista -> botao diz "Sair da lista" e tem de enviar um request para retirar do user_list_participants
             document.getElementById("buttonCancelList").innerHTML = "Sair da Lista";
             document.getElementById("buttonCancelList").onclick = function() {leaveList()};
         }
     }

     function writeLists(responseData){

            var listCategorias = ['Frutas e Legumes', 'Congelados', 'Bebidas', 'Mercearia', 'Lacticínios', 'Carne e Peixe', 'Bolachas e Doces', 'Charcutaria e Queijos'];
            var listCatSmall = ['FL', 'CL', 'BD', 'MC', 'LT', 'CP', 'BS', 'CQ'];
            var catCount = 8;
            var holdArray = [];


            var finalHTML = '';

            var itemPrefix = 'item';

            for(i = 0; i < catCount; i++){
                if(responseData['itemCounters'][listCatSmall[i]] > 0){

                    var catNameSplit = `<div class="row no-gutter align-items-center">
                    <div class="col-12 ">
                      <p class="category">` + listCategorias[i] + `</p>
                    </div>
                  </div> `

                    finalHTML = finalHTML + '\n' + catNameSplit;

                    for(j = 0; j < responseData['itemCounters'][listCatSmall[i]]; j++){

                        holdArray.push(responseData['productCatList'][listCategorias[i]][itemPrefix + j.toString()]['itemID']);
                        globalProds.push(responseData['productCatList'][listCategorias[i]][itemPrefix + j.toString()]['itemID']);

                        var itemLine = `<div class="row no-gutter2 align-items-center">
                <div class="col-6 col-sm-6 col-xs-6 col-xl-8" >
                  <p class="item" id="itemTextID`+responseData['productCatList'][listCategorias[i]][itemPrefix + j.toString()]['itemID'].toString()+`" onclick="hold(` + localListID.toString() + `,` + responseData['productCatList'][listCategorias[i]][itemPrefix + j.toString()]['itemID'].toString() +`)">` + responseData['productCatList'][listCategorias[i]][itemPrefix + j.toString()]['itemName'] + `</p>
                </div>
                <div id ="prodListMode` + responseData['productCatList'][listCategorias[i]][itemPrefix + j.toString()]['itemID'].toString() + `" class="col-6 col-sm-6 col-xs-6 col-xl-4 modeList text-right options">
                  <button class="btn btnIcon" onclick="addQuant(` + localListID.toString() + `,` + responseData['productCatList'][listCategorias[i]][itemPrefix + j.toString()]['itemID'].toString() + `)">
                    <i class="fas fa-plus-circle optionsIcon"></i>
                  </button>
                  <span class="quantity" id="quantity` + responseData['productCatList'][listCategorias[i]][itemPrefix + j.toString()]['itemID'].toString()+ `">` + responseData['productCatList'][listCategorias[i]][itemPrefix + j.toString()]['itemQuantity'].toString() + `</span>
                  <button class="btn btnIcon">
                    <i class="fas fa-minus-circle optionsIcon" onclick="remQuant(` + localListID.toString() + `,` + responseData['productCatList'][listCategorias[i]][itemPrefix + j.toString()]['itemID'].toString() + `)"></i>
                  </button>
                  <button class="btn btnIconDelete" id="delete` + responseData['productCatList'][listCategorias[i]][itemPrefix + j.toString()]['itemID'].toString()+ `">
                    <i class="fas fa-trash optionsIcon deleteIcon" onclick="delItem(` + localListID.toString() + `,` + responseData['productCatList'][listCategorias[i]][itemPrefix + j.toString()]['itemID'].toString() + `)"></i>
                  </button>
                </div>
                <div id="prodStoreMode` + responseData['productCatList'][listCategorias[i]][itemPrefix + j.toString()]['itemID'].toString() + `" class="col-6 col-sm-6 col-xs-6 col-xl-4 modeShop text-right">
                  <label class="container2C ">
                    <input type="checkbox" >
                    <span class="checkmark2"></span>
                  </label>
                </div>
              </div>`

                        finalHTML = finalHTML + '\n' + itemLine;

                    }

                }

            }
            document.getElementById("productsContainer").innerHTML = finalHTML;
            document.getElementById("listNameContainer").innerHTML = responseData['listName'];
            //hold functions need to execute twice to work -> first time to add the event listener, only after this will it actually execute what you want
            //so we call it once with the ids needed to add the event listener, this way when its called a second time by actually holding the button, it will work

            for(k = 0; k<holdArray.length; k++){

                hold(localListID,holdArray[k]);
            }
            calc();


        }

      function setAcceptedStores(storeID){

          if(acceptedStores.includes(storeID)){
            tempIndex = acceptedStores.indexOf(storeID);
            acceptedStores.splice(tempIndex,1);
          }
          else{
            acceptedStores.push(storeID);
          }

      }

      function saveChanges(){

          changeUserPrefs(acceptedStores);
          localStorage.setItem("acceptedStores",acceptedStores);
          calc();
          closeOverlay();
      }

      function sendAjaxUpdateQuantity(listID,productID,tag){
            console.log('Creating ajax object');
                var ajaxRequest = new XMLHttpRequest();
                ajaxRequest.onreadystatechange = function() {
                    if (ajaxRequest.readyState == 4) {   // XMLHttpRequest.DONE == 4
                        if (ajaxRequest.status == 200) {

                            var responseData = JSON.parse(ajaxRequest.responseText);
                            buttonCalc();
                        }
                        else if (ajaxRequest.status == 400) {
                            console.log('There was an error 400');
                        }
                        else {
                            console.log('something else other than 200 was returned');
                        }
                    }
                };
                console.log('Sending ajax');
                ajaxRequest.open("POST", "https://shapplist.pythonanywhere.com/api/listServices/api_addProducts", true);
                ajaxRequest.setRequestHeader("content-type", "application/json; charset=utf-8");
                data = JSON.stringify({'listID' : listID , 'productID' : productID, 'tag' : tag});

                ajaxRequest.send(data);
        }

      function sendAjaxDeleteItem(listID,productID){
         console.log('Creating ajax object');
                var ajaxRequest = new XMLHttpRequest();
                ajaxRequest.onreadystatechange = function() {
                    if (ajaxRequest.readyState == 4) {   // XMLHttpRequest.DONE == 4
                        if (ajaxRequest.status == 200) {

                            var responseData = JSON.parse(ajaxRequest.responseText);
                            pageSetup();
                        }
                        else if (ajaxRequest.status == 400) {
                            console.log('There was an error 400');
                        }
                        else {
                            console.log('something else other than 200 was returned');
                        }
                    }
                };
                console.log('Sending ajax');
                ajaxRequest.open("POST", "https://shapplist.pythonanywhere.com/api/listServices/api_removeProducts", true);
                ajaxRequest.setRequestHeader("content-type", "application/json; charset=utf-8");
                data = JSON.stringify({'listID' : listID , 'productID' : productID});

                ajaxRequest.send(data);
      }

      function sendAjaxDeleteList(){
          console.log('Creating ajax object');
                var ajaxRequest = new XMLHttpRequest();
                ajaxRequest.onreadystatechange = function() {
                    if (ajaxRequest.readyState == 4) {   // XMLHttpRequest.DONE == 4
                        if (ajaxRequest.status == 200) {

                            var responseData = JSON.parse(ajaxRequest.responseText);

                        }
                        else if (ajaxRequest.status == 400) {
                            console.log('There was an error 400');
                        }
                        else {
                            console.log('something else other than 200 was returned');
                        }
                    }
                };
                console.log('Sending ajax');
                ajaxRequest.open("POST", "https://shapplist.pythonanywhere.com/api/listServices/api_deleteList", true);
                ajaxRequest.setRequestHeader("content-type", "application/json; charset=utf-8");
                data = JSON.stringify({'listID' : localListID});

                ajaxRequest.send(data);
      }

      function sendAjaxLeaveList(){
          console.log('Creating ajax object');
                var ajaxRequest = new XMLHttpRequest();
                ajaxRequest.onreadystatechange = function() {
                    if (ajaxRequest.readyState == 4) {   // XMLHttpRequest.DONE == 4
                        if (ajaxRequest.status == 200) {

                            var responseData = JSON.parse(ajaxRequest.responseText);

                        }
                        else if (ajaxRequest.status == 400) {
                            console.log('There was an error 400');
                        }
                        else {
                            console.log('something else other than 200 was returned');
                        }
                    }
                };
                console.log('Sending ajax');
                ajaxRequest.open("POST", "https://shapplist.pythonanywhere.com/api/listServices/api_leaveList", true);
                ajaxRequest.setRequestHeader("content-type", "application/json; charset=utf-8");
                data = JSON.stringify({'listID' : localListID});

                ajaxRequest.send(data);
      }


      function sendAjaxGetUsersOfList(){
          console.log('Creating ajax object');
                var ajaxRequest = new XMLHttpRequest();
                ajaxRequest.onreadystatechange = function() {
                    if (ajaxRequest.readyState == 4) {   // XMLHttpRequest.DONE == 4
                        if (ajaxRequest.status == 200) {

                            var responseData = JSON.parse(ajaxRequest.responseText);
                            writeUsers(responseData);

                        }
                        else if (ajaxRequest.status == 400) {
                            console.log('There was an error 400');
                        }
                        else {
                            console.log('something else other than 200 was returned');
                        }
                    }
                };
                console.log('Sending ajax');
                ajaxRequest.open("POST", "https://shapplist.pythonanywhere.com/api/listServices/api_getInfoForUsersInList", true);
                ajaxRequest.setRequestHeader("content-type", "application/json; charset=utf-8");
                data = JSON.stringify({'listID' : localListID});

                ajaxRequest.send(data);
      }


      function writeUsers(responseData){
          var totalAcceptedUsers = responseData['Accepted']['totalAcceptedUsers'];
          var totalPendingUsers = responseData['Pending']['totalPendingUsers'];

          var acceptedHTML = "";
          var pendingHTML = "";
          if(totalAcceptedUsers > 0){
              for(i = 0; i < totalAcceptedUsers; i++){
                    temp_user = responseData['Accepted']['user'+i.toString()]['userID'];
                    var temp_html = `<div class="col-9 lists text-left">
                    <p class="overlaySuper" ><span id="partActiveName`+responseData['Accepted']['user'+i.toString()]['userID'].toString()+`" >`+responseData['Accepted']['user'+i.toString()]['userName']+`</span> - <span id="partActiveNumber`+responseData['Accepted']['user'+i.toString()]['userID'].toString()+`">`+responseData['Accepted']['user'+i.toString()]['phoneNum']+`</span></p>
                      </div>
                      <div class="col-3 lists text-right">
                        <button onclick="sendAjaxDelUserFromList(`+temp_user+`)" id="miniCaixotinho`+responseData['Accepted']['user'+i.toString()]['userID'].toString()+`"" class="btn btnIconPart">
                          <i class="fas fa-trash optionsIcon deleteIconPart"></i>
                        </button>
                      </div>`
                    acceptedHTML = acceptedHTML + temp_html;

              }
          }

          if(totalPendingUsers > 0){
              for( j = 0 ; j< totalPendingUsers; j++){
                    var temp_html = `<div class="col-12 lists text-left">
                        <p class="overlaySuper" ><span id="partPendingName">`+responseData['Pending']['user'+j.toString()]['userName']+`</span> - <span id="partPendingNumber">`+responseData['Pending']['user'+j.toString()]['phoneNum']+`</span></p>
                      </div>`;
                    pendingHTML = pendingHTML + temp_html;

             }
          }

          if(acceptedHTML.length > 0 && pendingHTML.length > 0){

                  document.getElementById("acceptedContainer").innerHTML = acceptedHTML;
                  document.getElementById("pendingContainer").innerHTML = pendingHTML;
          }
          else if(acceptedHTML.length > 0 && pendingHTML.length == 0){

                  document.getElementById("acceptedContainer").innerHTML = acceptedHTML;
                  document.getElementById("partPendingName").innerHTML = "-";
          }
          else if(acceptedHTML.length == 0 && pendingHTML.length > 0){

                  document.getElementById("partActiveName").innerHTML = "-";
                  document.getElementById("pendingContainer").innerHTML = pendingHTML;
          }
      }

      function sendAjaxDelUserFromList(userID){
          console.log('Creating ajax object');
                var ajaxRequest = new XMLHttpRequest();
                ajaxRequest.onreadystatechange = function() {
                    if (ajaxRequest.readyState == 4) {   // XMLHttpRequest.DONE == 4
                        if (ajaxRequest.status == 200) {

                            var responseData = JSON.parse(ajaxRequest.responseText);
                            document.getElementById("partActiveName"+userID).innerHTML = "";
                            document.getElementById("partActiveNumber"+userID).innerHTML = "";
                            document.getElementById("miniCaixotinho"+userID).style.display ="none";




                        }
                        else if (ajaxRequest.status == 400) {
                            console.log('There was an error 400');
                        }
                        else {
                            console.log('something else other than 200 was returned');
                        }
                    }
                };
                console.log('Sending ajax');
                ajaxRequest.open("POST", "https://shapplist.pythonanywhere.com/api/listServices/api_removeUserFromList", true);
                ajaxRequest.setRequestHeader("content-type", "application/json; charset=utf-8");
                data = JSON.stringify({'listID' : localListID, 'userID' : userID});

                ajaxRequest.send(data);
      }

      function sendAjaxUpdateDefaultList(){
          listID = localStorage.activeList;
          console.log('Creating ajax object');
                var ajaxRequest = new XMLHttpRequest();
                ajaxRequest.onreadystatechange = function() {
                    if (ajaxRequest.readyState == 4) {   // XMLHttpRequest.DONE == 4
                        if (ajaxRequest.status == 200) {
                            closeOverlay();
                        }
                        else if (ajaxRequest.status == 400) {
                            console.log('There was an error 400');
                        }
                        else {
                            console.log('something else other than 200 was returned');
                        }
                    }
                };
                console.log('Sending ajax');
                ajaxRequest.open("POST", "https://shapplist.pythonanywhere.com/api/listServices/api_updateDefaultList", true);
                ajaxRequest.setRequestHeader("content-type", "application/json; charset=utf-8");
                data = JSON.stringify({'listID' : listID});

                ajaxRequest.send(data);
      }

      function setActiveList(){
          localStorage.setItem("activeList", localListID);
          document.getElementById("makeListActive").style.display = "none";
          sendAjaxUpdateDefaultList();

      }

      function addQuant(listID, productID) {
        //document.getElementById("prodPrice").textContent = parseFloat(document.getElementById("prodPrice").textContent) / parseFloat(document.getElementById("quantity").textContent) * (parseFloat(document.getElementById("quantity").textContent) + 1)
        document.getElementById("quantity" + productID).innerHTML = parseFloat(document.getElementById("quantity"+ productID).textContent) + 1;
        sendAjaxUpdateQuantity(listID,productID, true)


      }

      function remQuant(listID, productID) {
        if (parseInt(document.getElementById("quantity"+productID).textContent)> 1){
          //document.getElementById("prodPrice").textContent = parseFloat(document.getElementById("prodPrice").textContent) / parseFloat(document.getElementById("quantity").textContent) * (parseFloat(document.getElementById("quantity").textContent) - 1)
          document.getElementById("quantity" + productID).innerHTML = parseFloat(document.getElementById("quantity"+ productID).textContent) - 1;
          sendAjaxUpdateQuantity(listID,productID, false)


        }
      }

      function delItem(listID, productID){
          sendAjaxDeleteItem(listID,productID);
          document.getElementById("overlayDelProd").style.display = "none";
          document.getElementById("closeOverlay").style.display = "none";
      }

      function delList(){
          sendAjaxDeleteList();
          closeOverlay();
          if(localStorage.activeList == localListID){
              localStorage.setItem("activeList", 0);
          }
          window.location.replace("/lists");
      }

      function leaveList(){
          sendAjaxLeaveList();
          closeOverlay();
          window.location.replace("/lists");
      }

      function openOverlay() {
        if(!localStorage.acceptedStores.includes(1)){
            document.getElementById("pingoCheck").checked = false;
        }
        if(!localStorage.acceptedStores.includes(2)){
            document.getElementById("contCheck").checked = false;
        }
        if(!localStorage.acceptedStores.includes(3)){
            document.getElementById("jumboCheck").checked = false;
        }
        document.getElementById("overlayPart").style.display = "none";
        document.getElementById("overlayAddPart").style.display = "none";
        document.getElementById("overlay").style.display = "block";
        document.getElementById("closeOverlay").style.display = "block";
      }


      function closeOverlay() {
        document.getElementById("overlay").style.display = "none";
        document.getElementById("overlayAddPart").style.display = "none";
        document.getElementById("closeOverlay").style.display = "none";
        document.getElementById("overlayDelProd").style.display = "none";
        document.getElementById("overlayPart").style.display = "none";
      }

      function openParts(){
        document.getElementById("overlay").style.display = "none";
        document.getElementById("overlayAddPart").style.display = "none";
        document.getElementById("closeOverlay").style.display = "block";
        document.getElementById("overlayPart").style.display = "block";
        sendAjaxGetUsersOfList();
      }

      function overlayOaC(){
        document.getElementById("overlayPart").style.display = "none";
        document.getElementById("overlayAddPart").style.display = "block";
        document.getElementById("closeOverlay").style.display = "block";
      }

      function changeMode(){
        if (mode == 0){
            if(globalProds.length > 0){
                for(i = 0; i < globalProds.length ; i++){
                  document.getElementById("prodListMode" + globalProds[i].toString()).style.display = "none";
                  document.getElementById("prodStoreMode"+ globalProds[i].toString()).style.display = "inline";
                  closeOverlay();
                  mode = 1;
                }
            }
            else{
                closeOverlay();
            }
        }
        else{
          if(globalProds.length > 0){
                for(j = 0; j < globalProds.length ; j++){
                  document.getElementById("prodListMode" + globalProds[j].toString()).style.display = "inline";
                  document.getElementById("prodStoreMode"+ globalProds[j].toString()).style.display = "none";
                  closeOverlay();
                  mode = 0;
                }
            }
            else{
                closeOverlay();
            }
        }
      }

      function calc(){
          itemsUniqueDict();

          setupItemArrays();
          totalPrices();

          document.getElementById("pricePG").innerHTML = pingoDoce_total_price_string;
          document.getElementById("priceC").innerHTML = continente_total_price_string;
          document.getElementById("priceJ").innerHTML = jumbo_total_price_string;

          getBestPrice();
          showMissingItems();
          resetEnv();
      }

      function buttonCalc(){
          sendAjaxGetList();
      }


    </script>


    <!--- Script Source Files -->
    <script src="{% static 'ShappList/js/jquery-3.3.1.min.js' %}"></script>
    <script src="{% static 'ShappList/bootstrap/js/bootstrap.min.js' %}"></script>
    <script src="https://use.fontawesome.com/releases/v5.5.0/js/all.js"></script>
    <!--- End of Script Source Files -->

    <!-- jQuery CDN - Slim version (=without AJAX) -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <!-- Popper.JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ" crossorigin="anonymous"></script>
    <!-- jQuery Custom Scroller CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.5/jquery.mCustomScrollbar.concat.min.js"></script>



  </body>
</html>
